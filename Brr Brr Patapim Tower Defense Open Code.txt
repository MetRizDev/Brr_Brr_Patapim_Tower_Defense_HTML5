<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Patapim: Ultimate War</title>
    <style>
        body { margin: 0; padding: 0; background: #1a2e18; color: #e0ffe0; font-family: 'Courier New', monospace; overflow: hidden; touch-action: none; }
        canvas { display: block; background: #4a7c44; cursor: crosshair; }
        
        #main-menu {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 1000;
        }

        #ui-layer {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(30, 50, 30, 0.95); display: flex; justify-content: center;
            padding: 10px 0; border-top: 4px solid #7fff00; gap: 8px; z-index: 10;
        }

        .slot {
            width: 70px; height: 85px; background: #4a6348; border: 2px solid #6a8c67;
            border-radius: 8px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; cursor: pointer; transition: 0.2s;
        }
        .slot.active { border-color: #7fff00; background: #3a5238; transform: scale(1.1); }
        .slot b { font-size: 12px; color: #fff; margin-top: 2px; }
        .slot img { width: 30px; height: 30px; object-fit: contain; }

        #stats-bar {
            position: absolute; top: 10px; left: 10px;
            background: rgba(0,0,0,0.6); padding: 12px; border-radius: 10px;
            pointer-events: none; z-index: 20; border: 1px solid #7fff00;
        }

        #speed-btn {
            position: absolute; top: 10px; right: 10px;
            background: #7fff00; color: #000; padding: 10px 20px;
            border-radius: 8px; font-weight: bold; cursor: pointer; z-index: 20; border: none;
        }

        #secret-panel {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #000; border: 3px solid #0f0; padding: 25px; z-index: 200;
            display: none; flex-direction: column; align-items: center;
        }
        .cheat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .cheat-grid button { background: #030; color: #0f0; border: 1px solid #0f0; padding: 10px; cursor: pointer; }
        .cheat-grid button.active { background: #0f0; color: #000; }

        .main-btn { padding: 20px 60px; font-size: 28px; cursor: pointer; background: #7fff00; border: none; border-radius: 15px; font-weight: bold; }
    </style>
</head>
<body>

<div id="main-menu">
    <h1 style="color: #7fff00; font-size: 40px;">PATAPIM: SAHUR ATTACK</h1>
    <button class="main-btn" onclick="startGame()">–ò–ì–†–ê–¢–¨</button>
</div>

<div id="stats-bar">
    üçÉ –õ–∏—Å—Ç—å—è: <span id="leafCount">20</span> | üåä –í–æ–ª–Ω–∞: <span id="waveDisplay">1</span><br>
    üè∞ –ë–∞—à–Ω—è: <span id="hpDisplay">100</span>%
</div>

<button id="speed-btn" onclick="toggleSpeed()">–°–ö–û–†–û–°–¢–¨: 1x</button>

<div id="ui-layer">
    <div class="slot" onclick="selectUnit('leaf', 5, this)"><span>üåø</span><b>5</b></div>
    <div class="slot" onclick="selectUnit('stick', 20, this)"><span>ü™µ</span><b>20</b></div>
    <div class="slot" onclick="selectUnit('tree', 45, this)"><span>üå≥</span><b>45</b></div>
    <div class="slot" onclick="selectUnit('forest', 75, this)"><span>‚ú®</span><b>75</b></div>
    <div class="slot" onclick="selectUnit('dmgCursor', 100, this)">
        <img src="https://external-content.duckduckgo.com/iu/?u=https%3A%2F%2Fimg.freepik.com%2Ffree-icon%2Fcursor_318-281832.jpg&f=1">
        <b>100</b>
    </div>
    <div class="slot" onclick="buyAutoCursor()">
        <img src="https://pngimg.com/uploads/cursor/cursor_PNG100716.png">
        <b>10</b>
    </div>
</div>

<div id="secret-panel">
    <h2 style="color:#0f0">CHEATS</h2>
    <div class="cheat-grid">
        <button onclick="leaves += 5000">üí∞ –õ–∏—Å—Ç—å—è</button>
        <button onclick="towerHp = 9999">üõ°Ô∏è God Mode</button>
        <button id="draw-btn" onclick="toggleDrawingMode()">üñåÔ∏è –†–ò–°–û–í–ê–ù–ò–ï: –í–´–ö–õ</button>
        <button onclick="enemies = []">‚ò†Ô∏è Kill All</button>
        <button onclick="closeSecret()">‚ùå –ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

const imgs = {
    patapim: 'https://static.tildacdn.com/tild3566-6565-4466-a564-393931643936/Brr_brr_Patapin.png',
    sahur: 'https://liroro.ru/wp-content/uploads/2025/04/Screenshot_2-29.jpg',
    boss67: 'https://soundboardguys.com/assets/images/blog-images/six-seven-kid.png',
    autoCursor: 'https://pngimg.com/uploads/cursor/cursor_PNG100716.png',
    dmgCursor: 'https://external-content.duckduckgo.com/iu/?u=https%3A%2F%2Fimg.freepik.com%2Ffree-icon%2Fcursor_318-281832.jpg&f=1',
    tititi: 'https://static.wikitide.net/italianbrainrotwiki/thumb/0/06/Tititi_sahur_reib.png/600px-Tititi_sahur_reib.png',
    tiktak: 'https://storage.beee.pro/game_items/46747/2e2ETwlZ7fgif8iHhA3Bem4h41Rg5qwzyOLWv7Po.png',
    tatata: 'https://static.wikia.nocookie.net/pixel-gun-3d/images/7/77/Sahur.png',
    krysun: 'https://static.wikia.nocookie.net/video-game-characters/images/7/7a/Twitch_Render.png'
};

const loadedImgs = {};
for (let k in imgs) { loadedImgs[k] = new Image(); loadedImgs[k].src = imgs[k]; }

let leaves = 20, towerHp = 100, wave = 1, frame = 0, isPaused = true, gameSpeed = 1;
let defenders = [], enemies = [], projectiles = [], enemyProjectiles = [], loot = [], autoCursors = [];
let selectedType = null, selectedCost = 0, enemiesLeft = 5, timeStop = 0;
let isDrawingMode = false, isMouseDown = false;

function startGame() { document.getElementById('main-menu').style.display = 'none'; isPaused = false; }
window.addEventListener('keydown', (e) => { if(e.key === "Insert") { let p = document.getElementById('secret-panel'); p.style.display = p.style.display === 'flex' ? 'none' : 'flex'; } });
function closeSecret() { document.getElementById('secret-panel').style.display = 'none'; }
function toggleDrawingMode() { isDrawingMode = !isDrawingMode; document.getElementById('draw-btn').innerText = `üñåÔ∏è –†–ò–°–û–í–ê–ù–ò–ï: ${isDrawingMode ? '–í–ö–õ' : '–í–´–ö–õ'}`; document.getElementById('draw-btn').classList.toggle('active'); }
function toggleSpeed() { gameSpeed = gameSpeed === 1 ? 4 : 1; document.getElementById('speed-btn').innerText = `–°–ö–û–†–û–°–¢–¨: ${gameSpeed}x`; }
function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener('resize', resize); resize();

const rawPath = [{x: 1.1, y: 0.6}, {x: 0.7, y: 0.6}, {x: 0.6, y: 0.2}, {x: 0.4, y: 0.2}, {x: 0.3, y: 0.75}, {x: 0.1, y: 0.75}];
function getPos(p) { return { x: p.x * canvas.width, y: p.y * canvas.height }; }

class Enemy {
    constructor(isBoss = false, type = 'normal') {
        this.isBoss = isBoss; this.type = type; this.wp = 0;
        let start = getPos(rawPath[0]); this.x = start.x; this.y = start.y;
        this.maxHp = (isBoss ? 450 : 35) * (1 + wave * 0.3);
        this.speed = isBoss ? 0.65 : 1.3;
        if (type === 'krysun') { this.maxHp *= 2; this.speed = 3.5; }
        if (type === 'tatata') this.shootTimer = 0;
        this.hp = this.maxHp;
        this.isBeingDragged = false;
        this.lifeTimer = type === 'tiktak' ? 350 : Infinity;
    }
    update() {
        if (this.isBeingDragged) return false;
        if (this.type === 'tiktak') { timeStop = 3; this.lifeTimer--; return this.lifeTimer <= 0; }
        
        let targetWP = rawPath[this.wp + 1];
        if (!targetWP) { towerHp -= this.isBoss ? 35 : 10; return true; }
        let tPos = getPos(targetWP);
        let dx = tPos.x - this.x, dy = tPos.y - this.y, dist = Math.hypot(dx, dy);

        // –£–Ω–∏–∫–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (–¢–∏-–¢–∏-–¢–∏ –∏ –¢–∞-–¢–∞-–¢–∞)
        let blocked = (this.type === 'tititi' || this.type === 'tatata') && defenders.some(d => Math.hypot(d.x - this.x, d.y - this.y) < 140);

        if (!blocked) {
            this.x += (dx/dist) * this.speed; this.y += (dy/dist) * this.speed;
            if (dist < 10) this.wp++;
        } else if (this.type === 'tatata') {
            this.shootTimer++;
            if (this.shootTimer % 120 === 0) {
                let targetPlant = defenders[Math.floor(Math.random()*defenders.length)];
                if (targetPlant && !(targetPlant instanceof DamageCursor)) {
                    enemyProjectiles.push({x: this.x, y: this.y, tx: targetPlant.x, ty: targetPlant.y, type: 'tea'});
                }
            }
        }
        return this.hp <= 0;
    }
    draw() {
        let s = this.isBoss ? 110 : 55; if(this.type === 'krysun') s = 140;
        let img = loadedImgs[this.type] || loadedImgs.sahur;
        if(this.isBoss && this.type === 'normal') img = loadedImgs.boss67;
        ctx.drawImage(img, this.x - s/2, this.y - s/2, s, s);
        ctx.fillStyle = 'red'; ctx.fillRect(this.x-20, this.y-s/2-10, 40, 5);
        ctx.fillStyle = 'lime'; ctx.fillRect(this.x-20, this.y-s/2-10, (this.hp/this.maxHp)*40, 5);
    }
}

class AutoCursor {
    constructor() { this.x = canvas.width/2; this.y = canvas.height/2; this.target = null; this.cooldown = 0; }
    update() {
        if (this.cooldown > 0) { this.cooldown--; return; }
        if (this.target && !loot.includes(this.target)) this.target = null; // –§–ò–ö–°: –µ—Å–ª–∏ –ª–∏—Å—Ç –ø—Ä–æ–ø–∞–ª
        if (!this.target && loot.length > 0) this.target = loot[0];
        if (this.target) {
            let dx = this.target.x - this.x, dy = this.target.y - this.y, dist = Math.hypot(dx, dy);
            if (dist < 15) { leaves += 4; loot = loot.filter(l => l !== this.target); this.target = null; this.cooldown = 50; }
            else { this.x += dx/dist * 8; this.y += dy/dist * 8; }
        }
    }
    draw() { ctx.drawImage(loadedImgs.autoCursor, this.x, this.y, 25, 30); }
}

class DamageCursor {
    constructor(x, y) { this.x = x; this.y = y; this.homeX = x; this.homeY = y; this.state = 'idle'; this.timer = 0; this.target = null; }
    update() {
        this.timer++;
        if (this.state === 'idle' && this.timer > 300) { this.target = enemies.find(e => !e.isBeingDragged); if(this.target) this.state = 'moving'; }
        if (this.state === 'moving' && this.target) {
            let dx = this.target.x - this.x, dy = this.target.y - this.y, d = Math.hypot(dx, dy);
            if (d < 15) { this.state = 'dragging'; this.target.isBeingDragged = true; } else { this.x += dx/d*12; this.y += dy/d*12; }
        }
        if (this.state === 'dragging' && this.target) {
            let start = getPos(rawPath[0]); let dx = start.x - this.x, dy = start.y - this.y, d = Math.hypot(dx, dy);
            if (d < 30) { this.target.isBeingDragged = false; this.target.wp = 0; this.state = 'returning'; }
            else { this.x += dx/d*9; this.y += dy/d*9; this.target.x = this.x; this.target.y = this.y; }
        }
        if (this.state === 'returning') {
            let dx = this.homeX - this.x, dy = this.homeY - this.y, d = Math.hypot(dx, dy);
            if (d < 5) { this.state = 'idle'; this.timer = 0; } else { this.x += dx/d*10; this.y += dy/d*10; }
        }
    }
    draw() { ctx.drawImage(loadedImgs.dmgCursor, this.x - 20, this.y - 20, 40, 40); }
}

function selectUnit(t, c, el) { 
    document.querySelectorAll('.slot').forEach(s => s.classList.remove('active'));
    if(selectedType === t) selectedType = null; else { selectedType = t; selectedCost = c; el.classList.add('active'); }
}
function buyAutoCursor() { if(leaves >= 10) { leaves -= 10; autoCursors.push(new AutoCursor()); } }

function placeUnit(x, y) {
    if(!selectedType) return;
    if(isDrawingMode || leaves >= selectedCost) {
        if(selectedType === 'dmgCursor') defenders.push(new DamageCursor(x, y));
        else defenders.push({x, y, type: selectedType, timer: 0, shootAnim: 0});
        if(!isDrawingMode) leaves -= selectedCost;
    }
}

canvas.onmousedown = (e) => { 
    isMouseDown = true;
    for(let i=loot.length-1; i>=0; i--) if(Math.hypot(loot[i].x-e.clientX, loot[i].y-e.clientY) < 40) { leaves += 4; loot.splice(i, 1); return; }
    placeUnit(e.clientX, e.clientY);
};
canvas.onmousemove = (e) => { if(isMouseDown && isDrawingMode) placeUnit(e.clientX, e.clientY); };
canvas.onmouseup = () => isMouseDown = false;

function loop() {
    if (isPaused) { requestAnimationFrame(loop); return; }
    timeStop = Math.max(0, timeStop - 0.02);

    for (let s = 0; s < gameSpeed; s++) {
        frame++;
        if (frame % 130 === 0 && enemiesLeft > 0) {
            let r = Math.random();
            if (wave >= 8 && r < 0.1) enemies.push(new Enemy(true, 'krysun'));
            else if (wave >= 5 && r < 0.15) enemies.push(new Enemy(true, 'tatata'));
            else if (r < 0.2) enemies.push(new Enemy(false, 'tititi'));
            else if (r < 0.1) enemies.push(new Enemy(false, 'tiktak'));
            else enemies.push(new Enemy());
            enemiesLeft--;
        }
        if (enemiesLeft <= 0 && enemies.length === 0) { wave++; enemiesLeft = 6 + wave; }
        if (frame % 200 === 0) loot.push({x: Math.random()*canvas.width, y: Math.random()*canvas.height});

        enemies.forEach((e, idx) => { if(e.update()) enemies.splice(idx, 1); });
        autoCursors.forEach(c => c.update());
        defenders.forEach(d => {
            if (d instanceof DamageCursor) { d.update(); return; }
            if (timeStop > 0) return;
            d.shootAnim = Math.max(0, d.shootAnim - 1); d.timer++;
            let reload = {leaf:45, stick:80, tree:110, forest:60}[d.type];
            if (d.timer % reload === 0) {
                let target = enemies.find(e => Math.hypot(e.x - d.x, e.y - d.y) < 400);
                if (target) { projectiles.push({x: d.x, y: d.y, target, dmg: 15}); d.shootAnim = 12; }
            }
        });

        projectiles.forEach((p, idx) => {
            let dx = p.target.x - p.x, dy = p.target.y - p.y, d = Math.hypot(dx, dy);
            p.x += dx/d*15; p.y += dy/d*15;
            if (d < 20) { p.target.hp -= p.dmg; projectiles.splice(idx, 1); }
        });

        enemyProjectiles.forEach((p, idx) => {
            let dx = p.tx - p.x, dy = p.ty - p.y, d = Math.hypot(dx, dy);
            p.x += dx/d*6; p.y += dy/d*6;
            if (d < 15) {
                defenders = defenders.filter(def => Math.hypot(def.x - p.x, def.y - p.y) > 35);
                enemyProjectiles.splice(idx, 1);
            }
        });
    }

    ctx.clearRect(0,0,canvas.width, canvas.height);
    ctx.strokeStyle = '#5a3d34'; ctx.lineWidth = 60; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
    ctx.beginPath(); rawPath.forEach((p, i) => { let pos = getPos(p); if(i===0) ctx.moveTo(pos.x, pos.y); else ctx.lineTo(pos.x, pos.y); });
    ctx.stroke();

    ctx.drawImage(loadedImgs.patapim, getPos(rawPath[5]).x - 40, getPos(rawPath[5]).y - 100, 100, 100);
    loot.forEach(l => { ctx.font = "30px Arial"; ctx.fillText('üçÉ', l.x, l.y); });

    defenders.forEach(d => {
        if (d instanceof DamageCursor) { d.draw(); return; }
        ctx.save();
        let bob = Math.sin(frame * 0.05) * 5;
        let scale = d.shootAnim > 0 ? 1.4 : 1.0;
        ctx.translate(d.x, d.y + bob); ctx.scale(scale, scale);
        ctx.font = "40px Arial"; ctx.textAlign = "center";
        ctx.fillText({leaf:'üåø', stick:'ü™µ', tree:'üå≥', forest:'‚ú®'}[d.type], 0, 15);
        ctx.restore();
    });

    enemies.forEach(e => e.draw());
    autoCursors.forEach(c => c.draw());
    projectiles.forEach(p => { ctx.fillStyle = '#ff0'; ctx.beginPath(); ctx.arc(p.x, p.y, 6, 0, Math.PI*2); ctx.fill(); });
    enemyProjectiles.forEach(p => { ctx.font = "24px Arial"; ctx.fillText('‚òï', p.x, p.y); });

    if(timeStop > 0) { ctx.fillStyle = 'rgba(0, 255, 255, 0.2)'; ctx.fillRect(0,0,canvas.width, canvas.height); }
    
    document.getElementById('leafCount').innerText = Math.floor(leaves);
    document.getElementById('hpDisplay').innerText = Math.max(0, towerHp);
    document.getElementById('waveDisplay').innerText = wave;
    requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>